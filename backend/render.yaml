# Render Blueprint for Paris Sportif Backend
# Deploy with: render.com/deploy
#
# Architecture:
#   Render (1GB+ RAM, 1 CPU) - API, Auth, DB, ML inference
#   HuggingFace Spaces (16GB) - ML Training only
#
# Optimized for performance with:
#   - 2 Gunicorn workers (1 CPU = 2*CPU+1 workers optimal)
#   - Pre-calculated predictions cached in DB + Redis
#   - Team stats computed during sync, not on request

services:
  # FastAPI Backend
  - type: web
    name: paris-sportif-api
    runtime: python
    plan: standard  # 1GB+ RAM, 1 CPU - Full ML inference capability
    buildCommand: pip install -e . && pip install gunicorn
    startCommand: gunicorn src.api.main:app -w 2 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT --timeout 120 --keep-alive 5 --max-requests 500 --max-requests-jitter 50
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: paris-sportif-db
          property: connectionString
      - key: FOOTBALL_DATA_API_KEY
        sync: false
      - key: GROQ_API_KEY
        sync: false
      - key: SUPABASE_JWT_SECRET
        sync: false
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      # Redis Cache (Upstash)
      - key: REDIS_URL
        sync: false  # rediss://default:xxx@splendid-muskrat-38783.upstash.io:6379
      # Qdrant Vector DB (Cloud)
      - key: QDRANT_URL
        sync: false  # https://xxx.europe-west3-0.gcp.cloud.qdrant.io:6333
      - key: QDRANT_API_KEY
        sync: false
      # HuggingFace ML Service Integration
      - key: HF_ML_SERVICE_URL
        value: https://jdevot244-paris-sportif.hf.space
      - key: HF_TRAINING_API_KEY
        sync: false  # Shared secret with HuggingFace for training data access
      # Stripe Payments
      - key: STRIPE_SECRET_KEY
        sync: false
      - key: STRIPE_WEBHOOK_SECRET
        sync: false
      - key: STRIPE_PRICE_PREMIUM
        sync: false
      - key: STRIPE_PRICE_ELITE
        sync: false
      # Odds API (optional)
      - key: ODDS_API_KEY
        sync: false
      - key: APP_ENV
        value: production
      - key: DEBUG
        value: false
    healthCheckPath: /health

databases:
  # PostgreSQL Database (Free tier: 256MB, 90 days)
  - name: paris-sportif-db
    plan: free
    databaseName: paris_sportif
    user: paris_sportif

# =============================================================================
# HuggingFace Space Configuration (external)
# =============================================================================
# URL: https://huggingface.co/spaces/jdevot244/paris-sportif
# API: https://jdevot244-paris-sportif.hf.space
#
# Required env vars on HuggingFace:
#   BACKEND_API_URL=https://paris-sportif-api.onrender.com
#   HF_TRAINING_API_KEY=<same as Render>
#
# Features:
#   - XGBoost & Random Forest training/inference
#   - Auto-training on startup if no models
#   - Weekly retraining (Sundays 3 AM)
#   - 16GB RAM (free tier)
# =============================================================================
