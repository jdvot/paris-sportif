"""add_tennis_models

Revision ID: 438d0fd7a51a
Revises: 2c4daf5ea9d7
Create Date: 2026-02-06 13:29:46.987523

"""

from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = "438d0fd7a51a"
down_revision: Union[str, Sequence[str], None] = "2c4daf5ea9d7"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f("idx_user_profiles_role"), table_name="user_profiles")
    op.drop_table("user_profiles")
    op.alter_column(
        "cached_data",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
    )
    op.alter_column(
        "cached_data",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
    )
    op.drop_constraint(op.f("cached_data_cache_key_key"), "cached_data", type_="unique")
    op.drop_index(op.f("idx_cached_data_expires"), table_name="cached_data")
    op.drop_index(op.f("idx_cached_data_key"), table_name="cached_data")
    op.create_index(op.f("ix_cached_data_cache_key"), "cached_data", ["cache_key"], unique=True)
    op.create_index(op.f("ix_cached_data_cache_type"), "cached_data", ["cache_type"], unique=False)
    op.create_index(op.f("ix_cached_data_expires_at"), "cached_data", ["expires_at"], unique=False)
    op.alter_column(
        "matches",
        "external_id",
        existing_type=sa.TEXT(),
        type_=sa.String(length=50),
        nullable=False,
    )
    op.alter_column("matches", "home_team_id", existing_type=sa.INTEGER(), nullable=False)
    op.alter_column("matches", "away_team_id", existing_type=sa.INTEGER(), nullable=False)
    op.alter_column(
        "matches",
        "competition_code",
        existing_type=sa.TEXT(),
        type_=sa.String(length=10),
        nullable=False,
    )
    op.alter_column(
        "matches", "match_date", existing_type=postgresql.TIMESTAMP(timezone=True), nullable=False
    )
    op.alter_column(
        "matches", "status", existing_type=sa.TEXT(), type_=sa.String(length=20), nullable=False
    )
    op.alter_column(
        "matches",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        type_=sa.DateTime(),
        nullable=False,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
    )
    op.alter_column(
        "matches",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        type_=sa.DateTime(),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.drop_index(op.f("idx_matches_competition"), table_name="matches")
    op.drop_index(op.f("idx_matches_date"), table_name="matches")
    op.drop_constraint(op.f("matches_external_id_key"), "matches", type_="unique")
    op.create_index(
        op.f("ix_matches_competition_code"), "matches", ["competition_code"], unique=False
    )
    op.create_index(
        "ix_matches_competition_date", "matches", ["competition_code", "match_date"], unique=False
    )
    op.create_index("ix_matches_date_status", "matches", ["match_date", "status"], unique=False)
    op.create_index(op.f("ix_matches_external_id"), "matches", ["external_id"], unique=True)
    op.create_index(op.f("ix_matches_match_date"), "matches", ["match_date"], unique=False)
    op.create_index("ix_matches_status", "matches", ["status"], unique=False)
    op.create_foreign_key(None, "matches", "teams", ["away_team_id"], ["id"])
    op.create_foreign_key(None, "matches", "teams", ["home_team_id"], ["id"])
    op.alter_column(
        "ml_models",
        "model_name",
        existing_type=sa.TEXT(),
        type_=sa.String(length=100),
        nullable=False,
    )
    op.alter_column(
        "ml_models",
        "model_type",
        existing_type=sa.TEXT(),
        type_=sa.String(length=50),
        nullable=False,
    )
    op.alter_column(
        "ml_models", "version", existing_type=sa.TEXT(), type_=sa.String(length=20), nullable=False
    )
    op.alter_column(
        "ml_models",
        "accuracy",
        existing_type=sa.REAL(),
        type_=sa.Numeric(precision=5, scale=4),
        existing_nullable=True,
    )
    op.alter_column("ml_models", "training_samples", existing_type=sa.INTEGER(), nullable=False)
    op.alter_column(
        "ml_models",
        "is_active",
        existing_type=sa.BOOLEAN(),
        nullable=False,
        existing_server_default=sa.text("false"),
    )
    op.alter_column(
        "ml_models",
        "trained_at",
        existing_type=sa.TEXT(),
        type_=sa.DateTime(),
        existing_nullable=True,
        postgresql_using="trained_at::timestamp without time zone",
    )
    op.alter_column(
        "ml_models",
        "created_at",
        existing_type=sa.TEXT(),
        type_=sa.DateTime(),
        nullable=False,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
        postgresql_using="created_at::timestamp without time zone",
    )
    op.alter_column(
        "ml_models",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.drop_constraint(op.f("ml_models_model_name_key"), "ml_models", type_="unique")
    op.create_index(op.f("ix_ml_models_model_name"), "ml_models", ["model_name"], unique=True)
    op.alter_column("predictions", "match_id", existing_type=sa.INTEGER(), nullable=False)
    op.alter_column(
        "predictions", "home_prob", existing_type=sa.NUMERIC(precision=5, scale=4), nullable=False
    )
    op.alter_column(
        "predictions",
        "draw_prob",
        existing_type=sa.REAL(),
        type_=sa.Numeric(precision=5, scale=4),
        nullable=False,
    )
    op.alter_column(
        "predictions", "away_prob", existing_type=sa.NUMERIC(precision=5, scale=4), nullable=False
    )
    op.alter_column(
        "predictions", "predicted_outcome", existing_type=sa.VARCHAR(length=10), nullable=False
    )
    op.alter_column(
        "predictions",
        "confidence",
        existing_type=sa.REAL(),
        type_=sa.Numeric(precision=5, scale=4),
        nullable=False,
    )
    op.alter_column(
        "predictions",
        "is_daily_pick",
        existing_type=sa.BOOLEAN(),
        nullable=False,
        existing_server_default=sa.text("false"),
    )
    op.alter_column(
        "predictions",
        "match_context_summary",
        existing_type=sa.TEXT(),
        comment=None,
        existing_comment="LLM-generated match context summary from RAG data",
        existing_nullable=True,
    )
    op.alter_column(
        "predictions",
        "news_sources",
        existing_type=sa.TEXT(),
        comment=None,
        existing_comment="JSON array of news sources used for context",
        existing_nullable=True,
    )
    op.alter_column(
        "predictions",
        "created_at",
        existing_type=sa.TEXT(),
        type_=sa.DateTime(),
        nullable=False,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
        postgresql_using="created_at::timestamp without time zone",
    )
    op.alter_column(
        "predictions",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.drop_index(op.f("idx_predictions_match"), table_name="predictions")
    op.create_index(
        op.f("ix_predictions_is_daily_pick"), "predictions", ["is_daily_pick"], unique=False
    )
    op.create_foreign_key(None, "predictions", "matches", ["match_id"], ["id"])
    op.alter_column(
        "standings",
        "competition_code",
        existing_type=sa.TEXT(),
        type_=sa.String(length=10),
        nullable=False,
    )
    op.alter_column("standings", "position", existing_type=sa.INTEGER(), nullable=False)
    op.alter_column("standings", "team_id", existing_type=sa.INTEGER(), nullable=False)
    op.alter_column(
        "standings",
        "team_name",
        existing_type=sa.TEXT(),
        type_=sa.String(length=100),
        nullable=False,
    )
    op.alter_column("standings", "played_games", existing_type=sa.INTEGER(), nullable=False)
    op.alter_column("standings", "won", existing_type=sa.INTEGER(), nullable=False)
    op.alter_column("standings", "drawn", existing_type=sa.INTEGER(), nullable=False)
    op.alter_column("standings", "lost", existing_type=sa.INTEGER(), nullable=False)
    op.alter_column("standings", "goals_for", existing_type=sa.INTEGER(), nullable=False)
    op.alter_column("standings", "goals_against", existing_type=sa.INTEGER(), nullable=False)
    op.alter_column("standings", "goal_difference", existing_type=sa.INTEGER(), nullable=False)
    op.alter_column("standings", "points", existing_type=sa.INTEGER(), nullable=False)
    op.alter_column(
        "standings",
        "synced_at",
        existing_type=sa.TEXT(),
        type_=sa.DateTime(),
        existing_nullable=True,
        postgresql_using="synced_at::timestamp without time zone",
    )
    op.alter_column(
        "standings",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "standings",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.drop_index(op.f("idx_standings_competition"), table_name="standings")
    op.drop_constraint(op.f("standings_competition_code_team_id_key"), "standings", type_="unique")
    op.create_index("ix_standings_competition", "standings", ["competition_code"], unique=False)
    op.create_index(
        op.f("ix_standings_competition_code"), "standings", ["competition_code"], unique=False
    )
    op.create_index(
        "ix_standings_position", "standings", ["competition_code", "position"], unique=False
    )
    op.create_index(
        "uq_standings_comp_team", "standings", ["competition_code", "team_id"], unique=True
    )
    op.alter_column(
        "sync_log", "sync_type", existing_type=sa.TEXT(), type_=sa.String(length=50), nullable=False
    )
    op.alter_column(
        "sync_log", "status", existing_type=sa.TEXT(), type_=sa.String(length=20), nullable=False
    )
    op.alter_column("sync_log", "records_synced", existing_type=sa.INTEGER(), nullable=False)
    op.alter_column(
        "sync_log",
        "started_at",
        existing_type=sa.TEXT(),
        type_=sa.DateTime(),
        nullable=False,
        postgresql_using="started_at::timestamp without time zone",
    )
    op.alter_column(
        "sync_log",
        "completed_at",
        existing_type=sa.TEXT(),
        type_=sa.DateTime(),
        existing_nullable=True,
        postgresql_using="completed_at::timestamp without time zone",
    )
    op.create_index(op.f("ix_sync_log_sync_type"), "sync_log", ["sync_type"], unique=False)
    op.create_index("ix_sync_log_type_date", "sync_log", ["sync_type", "started_at"], unique=False)
    op.alter_column(
        "teams", "external_id", existing_type=sa.TEXT(), type_=sa.String(length=50), nullable=False
    )
    op.alter_column(
        "teams",
        "name",
        existing_type=sa.TEXT(),
        type_=sa.String(length=100),
        existing_nullable=False,
    )
    op.alter_column(
        "teams",
        "short_name",
        existing_type=sa.TEXT(),
        type_=sa.String(length=10),
        existing_nullable=True,
    )
    op.alter_column(
        "teams", "tla", existing_type=sa.TEXT(), type_=sa.String(length=5), existing_nullable=True
    )
    op.alter_column(
        "teams",
        "country",
        existing_type=sa.TEXT(),
        type_=sa.String(length=50),
        existing_nullable=True,
    )
    op.alter_column(
        "teams",
        "elo_rating",
        existing_type=sa.NUMERIC(precision=6, scale=1),
        nullable=False,
        existing_server_default=sa.text("1500.0"),
    )
    op.alter_column(
        "teams",
        "form",
        existing_type=sa.VARCHAR(length=20),
        type_=sa.String(length=10),
        comment=None,
        existing_comment="Recent form e.g. W,W,D,L,W",
        existing_nullable=True,
    )
    op.alter_column(
        "teams",
        "form_score",
        existing_type=sa.NUMERIC(precision=4, scale=3),
        comment=None,
        existing_comment="Form score 0-1 calculated from form string",
        existing_nullable=True,
    )
    op.alter_column(
        "teams",
        "last_match_date",
        existing_type=postgresql.TIMESTAMP(),
        comment=None,
        existing_comment="Date of most recent match",
        existing_nullable=True,
    )
    op.alter_column(
        "teams",
        "rest_days",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="Days since last match",
        existing_nullable=True,
        existing_server_default=sa.text("7"),
    )
    op.alter_column(
        "teams",
        "fixture_congestion",
        existing_type=sa.NUMERIC(precision=3, scale=2),
        type_=sa.Numeric(precision=4, scale=3),
        comment=None,
        existing_comment="Matches in last 14 days / 4 (0-1 scale)",
        existing_nullable=True,
        existing_server_default=sa.text("0"),
    )
    op.alter_column(
        "teams",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=False,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
    )
    op.alter_column(
        "teams",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=False,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
    )
    op.drop_constraint(op.f("teams_external_id_key"), "teams", type_="unique")
    op.create_index(op.f("ix_teams_external_id"), "teams", ["external_id"], unique=True)
    op.create_index(op.f("ix_user_favorites_user_id"), "user_favorites", ["user_id"], unique=False)
    op.alter_column(
        "user_preferences",
        "favorite_team_id",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="Primary favorite team for homepage personalization",
        existing_nullable=True,
    )
    op.drop_index(
        op.f("idx_user_preferences_favorite_team"),
        table_name="user_preferences",
        postgresql_where="(favorite_team_id IS NOT NULL)",
    )
    op.drop_constraint(
        op.f("user_preferences_favorite_team_id_fkey"), "user_preferences", type_="foreignkey"
    )
    op.create_foreign_key(None, "user_preferences", "teams", ["favorite_team_id"], ["id"])
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(None, "user_preferences", type_="foreignkey")
    op.create_foreign_key(
        op.f("user_preferences_favorite_team_id_fkey"),
        "user_preferences",
        "teams",
        ["favorite_team_id"],
        ["id"],
        ondelete="SET NULL",
    )
    op.create_index(
        op.f("idx_user_preferences_favorite_team"),
        "user_preferences",
        ["favorite_team_id"],
        unique=False,
        postgresql_where="(favorite_team_id IS NOT NULL)",
    )
    op.alter_column(
        "user_preferences",
        "favorite_team_id",
        existing_type=sa.INTEGER(),
        comment="Primary favorite team for homepage personalization",
        existing_nullable=True,
    )
    op.drop_index(op.f("ix_user_favorites_user_id"), table_name="user_favorites")
    op.drop_index(op.f("ix_teams_external_id"), table_name="teams")
    op.create_unique_constraint(
        op.f("teams_external_id_key"), "teams", ["external_id"], postgresql_nulls_not_distinct=False
    )
    op.alter_column(
        "teams",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=True,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
    )
    op.alter_column(
        "teams",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=True,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
    )
    op.alter_column(
        "teams",
        "fixture_congestion",
        existing_type=sa.Numeric(precision=4, scale=3),
        type_=sa.NUMERIC(precision=3, scale=2),
        comment="Matches in last 14 days / 4 (0-1 scale)",
        existing_nullable=True,
        existing_server_default=sa.text("0"),
    )
    op.alter_column(
        "teams",
        "rest_days",
        existing_type=sa.INTEGER(),
        comment="Days since last match",
        existing_nullable=True,
        existing_server_default=sa.text("7"),
    )
    op.alter_column(
        "teams",
        "last_match_date",
        existing_type=postgresql.TIMESTAMP(),
        comment="Date of most recent match",
        existing_nullable=True,
    )
    op.alter_column(
        "teams",
        "form_score",
        existing_type=sa.NUMERIC(precision=4, scale=3),
        comment="Form score 0-1 calculated from form string",
        existing_nullable=True,
    )
    op.alter_column(
        "teams",
        "form",
        existing_type=sa.String(length=10),
        type_=sa.VARCHAR(length=20),
        comment="Recent form e.g. W,W,D,L,W",
        existing_nullable=True,
    )
    op.alter_column(
        "teams",
        "elo_rating",
        existing_type=sa.NUMERIC(precision=6, scale=1),
        nullable=True,
        existing_server_default=sa.text("1500.0"),
    )
    op.alter_column(
        "teams",
        "country",
        existing_type=sa.String(length=50),
        type_=sa.TEXT(),
        existing_nullable=True,
    )
    op.alter_column(
        "teams", "tla", existing_type=sa.String(length=5), type_=sa.TEXT(), existing_nullable=True
    )
    op.alter_column(
        "teams",
        "short_name",
        existing_type=sa.String(length=10),
        type_=sa.TEXT(),
        existing_nullable=True,
    )
    op.alter_column(
        "teams",
        "name",
        existing_type=sa.String(length=100),
        type_=sa.TEXT(),
        existing_nullable=False,
    )
    op.alter_column(
        "teams", "external_id", existing_type=sa.String(length=50), type_=sa.TEXT(), nullable=True
    )
    op.drop_index("ix_sync_log_type_date", table_name="sync_log")
    op.drop_index(op.f("ix_sync_log_sync_type"), table_name="sync_log")
    op.alter_column(
        "sync_log",
        "completed_at",
        existing_type=sa.DateTime(),
        type_=sa.TEXT(),
        existing_nullable=True,
    )
    op.alter_column(
        "sync_log", "started_at", existing_type=sa.DateTime(), type_=sa.TEXT(), nullable=True
    )
    op.alter_column("sync_log", "records_synced", existing_type=sa.INTEGER(), nullable=True)
    op.alter_column(
        "sync_log", "status", existing_type=sa.String(length=20), type_=sa.TEXT(), nullable=True
    )
    op.alter_column(
        "sync_log", "sync_type", existing_type=sa.String(length=50), type_=sa.TEXT(), nullable=True
    )
    op.drop_index("uq_standings_comp_team", table_name="standings")
    op.drop_index("ix_standings_position", table_name="standings")
    op.drop_index(op.f("ix_standings_competition_code"), table_name="standings")
    op.drop_index("ix_standings_competition", table_name="standings")
    op.create_unique_constraint(
        op.f("standings_competition_code_team_id_key"),
        "standings",
        ["competition_code", "team_id"],
        postgresql_nulls_not_distinct=False,
    )
    op.create_index(
        op.f("idx_standings_competition"), "standings", ["competition_code"], unique=False
    )
    op.alter_column(
        "standings",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "standings",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "standings",
        "synced_at",
        existing_type=sa.DateTime(),
        type_=sa.TEXT(),
        existing_nullable=True,
    )
    op.alter_column("standings", "points", existing_type=sa.INTEGER(), nullable=True)
    op.alter_column("standings", "goal_difference", existing_type=sa.INTEGER(), nullable=True)
    op.alter_column("standings", "goals_against", existing_type=sa.INTEGER(), nullable=True)
    op.alter_column("standings", "goals_for", existing_type=sa.INTEGER(), nullable=True)
    op.alter_column("standings", "lost", existing_type=sa.INTEGER(), nullable=True)
    op.alter_column("standings", "drawn", existing_type=sa.INTEGER(), nullable=True)
    op.alter_column("standings", "won", existing_type=sa.INTEGER(), nullable=True)
    op.alter_column("standings", "played_games", existing_type=sa.INTEGER(), nullable=True)
    op.alter_column(
        "standings",
        "team_name",
        existing_type=sa.String(length=100),
        type_=sa.TEXT(),
        nullable=True,
    )
    op.alter_column("standings", "team_id", existing_type=sa.INTEGER(), nullable=True)
    op.alter_column("standings", "position", existing_type=sa.INTEGER(), nullable=True)
    op.alter_column(
        "standings",
        "competition_code",
        existing_type=sa.String(length=10),
        type_=sa.TEXT(),
        nullable=True,
    )
    op.drop_constraint(None, "predictions", type_="foreignkey")
    op.drop_index(op.f("ix_predictions_is_daily_pick"), table_name="predictions")
    op.create_index(op.f("idx_predictions_match"), "predictions", ["match_id"], unique=False)
    op.alter_column(
        "predictions",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "predictions",
        "created_at",
        existing_type=sa.DateTime(),
        type_=sa.TEXT(),
        nullable=True,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
    )
    op.alter_column(
        "predictions",
        "news_sources",
        existing_type=sa.TEXT(),
        comment="JSON array of news sources used for context",
        existing_nullable=True,
    )
    op.alter_column(
        "predictions",
        "match_context_summary",
        existing_type=sa.TEXT(),
        comment="LLM-generated match context summary from RAG data",
        existing_nullable=True,
    )
    op.alter_column(
        "predictions",
        "is_daily_pick",
        existing_type=sa.BOOLEAN(),
        nullable=True,
        existing_server_default=sa.text("false"),
    )
    op.alter_column(
        "predictions",
        "confidence",
        existing_type=sa.Numeric(precision=5, scale=4),
        type_=sa.REAL(),
        nullable=True,
    )
    op.alter_column(
        "predictions", "predicted_outcome", existing_type=sa.VARCHAR(length=10), nullable=True
    )
    op.alter_column(
        "predictions", "away_prob", existing_type=sa.NUMERIC(precision=5, scale=4), nullable=True
    )
    op.alter_column(
        "predictions",
        "draw_prob",
        existing_type=sa.Numeric(precision=5, scale=4),
        type_=sa.REAL(),
        nullable=True,
    )
    op.alter_column(
        "predictions", "home_prob", existing_type=sa.NUMERIC(precision=5, scale=4), nullable=True
    )
    op.alter_column("predictions", "match_id", existing_type=sa.INTEGER(), nullable=True)
    op.drop_index(op.f("ix_ml_models_model_name"), table_name="ml_models")
    op.create_unique_constraint(
        op.f("ml_models_model_name_key"),
        "ml_models",
        ["model_name"],
        postgresql_nulls_not_distinct=False,
    )
    op.alter_column(
        "ml_models",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "ml_models",
        "created_at",
        existing_type=sa.DateTime(),
        type_=sa.TEXT(),
        nullable=True,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
    )
    op.alter_column(
        "ml_models",
        "trained_at",
        existing_type=sa.DateTime(),
        type_=sa.TEXT(),
        existing_nullable=True,
    )
    op.alter_column(
        "ml_models",
        "is_active",
        existing_type=sa.BOOLEAN(),
        nullable=True,
        existing_server_default=sa.text("false"),
    )
    op.alter_column("ml_models", "training_samples", existing_type=sa.INTEGER(), nullable=True)
    op.alter_column(
        "ml_models",
        "accuracy",
        existing_type=sa.Numeric(precision=5, scale=4),
        type_=sa.REAL(),
        existing_nullable=True,
    )
    op.alter_column(
        "ml_models", "version", existing_type=sa.String(length=20), type_=sa.TEXT(), nullable=True
    )
    op.alter_column(
        "ml_models",
        "model_type",
        existing_type=sa.String(length=50),
        type_=sa.TEXT(),
        nullable=True,
    )
    op.alter_column(
        "ml_models",
        "model_name",
        existing_type=sa.String(length=100),
        type_=sa.TEXT(),
        nullable=True,
    )
    op.drop_constraint(None, "matches", type_="foreignkey")
    op.drop_constraint(None, "matches", type_="foreignkey")
    op.drop_index("ix_matches_status", table_name="matches")
    op.drop_index(op.f("ix_matches_match_date"), table_name="matches")
    op.drop_index(op.f("ix_matches_external_id"), table_name="matches")
    op.drop_index("ix_matches_date_status", table_name="matches")
    op.drop_index("ix_matches_competition_date", table_name="matches")
    op.drop_index(op.f("ix_matches_competition_code"), table_name="matches")
    op.create_unique_constraint(
        op.f("matches_external_id_key"),
        "matches",
        ["external_id"],
        postgresql_nulls_not_distinct=False,
    )
    op.create_index(op.f("idx_matches_date"), "matches", ["match_date"], unique=False)
    op.create_index(op.f("idx_matches_competition"), "matches", ["competition_code"], unique=False)
    op.alter_column(
        "matches",
        "updated_at",
        existing_type=sa.DateTime(),
        type_=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "matches",
        "created_at",
        existing_type=sa.DateTime(),
        type_=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
    )
    op.alter_column(
        "matches", "status", existing_type=sa.String(length=20), type_=sa.TEXT(), nullable=True
    )
    op.alter_column(
        "matches", "match_date", existing_type=postgresql.TIMESTAMP(timezone=True), nullable=True
    )
    op.alter_column(
        "matches",
        "competition_code",
        existing_type=sa.String(length=10),
        type_=sa.TEXT(),
        nullable=True,
    )
    op.alter_column("matches", "away_team_id", existing_type=sa.INTEGER(), nullable=True)
    op.alter_column("matches", "home_team_id", existing_type=sa.INTEGER(), nullable=True)
    op.alter_column(
        "matches", "external_id", existing_type=sa.String(length=50), type_=sa.TEXT(), nullable=True
    )
    op.drop_index(op.f("ix_cached_data_expires_at"), table_name="cached_data")
    op.drop_index(op.f("ix_cached_data_cache_type"), table_name="cached_data")
    op.drop_index(op.f("ix_cached_data_cache_key"), table_name="cached_data")
    op.create_index(op.f("idx_cached_data_key"), "cached_data", ["cache_key"], unique=False)
    op.create_index(op.f("idx_cached_data_expires"), "cached_data", ["expires_at"], unique=False)
    op.create_unique_constraint(
        op.f("cached_data_cache_key_key"),
        "cached_data",
        ["cache_key"],
        postgresql_nulls_not_distinct=False,
    )
    op.alter_column(
        "cached_data",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
    )
    op.alter_column(
        "cached_data",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
    )
    op.create_table(
        "user_profiles",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("email", sa.TEXT(), autoincrement=False, nullable=False),
        sa.Column("full_name", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("avatar_url", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "role",
            sa.TEXT(),
            server_default=sa.text("'free'::text"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.CheckConstraint(
            "role = ANY (ARRAY['free'::text, 'premium'::text, 'admin'::text])",
            name=op.f("user_profiles_role_check"),
        ),
        sa.ForeignKeyConstraint(
            ["id"], ["auth.users.id"], name=op.f("user_profiles_id_fkey"), ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("user_profiles_pkey")),
    )
    op.create_index(op.f("idx_user_profiles_role"), "user_profiles", ["role"], unique=False)
    # ### end Alembic commands ###
